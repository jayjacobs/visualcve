---
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: false
    theme: paper
    code_folding: none
    toc_float:
        collapsed: false
        smooth_scroll: false
---

```{r setup, echo=FALSE}
suppressPackageStartupMessages({
  suppressWarnings({
    library(dplyr)
    library(tibble)
    library(tidyr)
    library(readr)
    library(stringr)
    library(here)
    library(scales)
    library(log4r)
    library(lubridate)
    library(purrr)
    library(arrow)
    library(tidyjson)
    library(ggplot2)
    library(ggrepel)
    library(gt)
    library(xml2)
    library(patchwork)
  })
})

mainfont <- "Source Sans Pro"
tab <- function (x = c("blue", "orange", "red", "seablue", "green", 
                       "olive", "purple", "pink", "brown", "gray")) {
  tableau <- c(blue = "#4E79A7", orange = "#F28E2B", red = "#E15759", seablue = "#76B7B2", 
               green = "#59A14F", olive = "#EDC948", purple = "#B07AA1", pink = "#FF9DA7", 
               brown = "#9C755F", gray = "#BAB0AC")
  as.vector(tableau[x])
}

theme_set(theme_minimal(base_family=mainfont) +
            theme(panel.grid = element_line(color="gray95"),
                  plot.caption = element_text(size=6, face = "italic", color="gray60"),
                  text = element_text(family=mainfont),
                  legend.title = element_blank(),
                  legend.position="bottom"))
update_geom_defaults('col', list(fill=tab('blue')))
update_geom_defaults('bar', list(fill=tab('blue')))
update_geom_defaults('text', list(family=mainfont, size=8/.pt))
update_geom_defaults('label', list(family=mainfont, size=8/.pt, label.size=NA))
# update_geom_defaults('point', list(shape=21, size=2, fill=tab('blue'), color='white'))
update_geom_defaults('point', list(size=0.5, color=tab('blue')))
update_geom_defaults('line', list(color=tab('blue'), size=0.85))

knitr::opts_chunk$set(
  cache = FALSE,
  message = FALSE,
  warning = FALSE, 
  dev = c("png", "cairo_pdf"),
  echo = FALSE,
  fig.retina = 2,
  fig.width = 7,
  fig.height = 3.5
)
```

```{r}
cves <- read_parquet(here("cache/cveparse/cves.parquet")) |> 
  select(-contains(".x_"))
fixed_dates <- read_csv(here("cache", "legacy_cve_published_dates.csv"), show_col_types = FALSE) %>% 
  select(cve, fixed_published = legacy_date_published)
cvepub <- cves %>% 
  select(cve, published = cveMetadata.datePublished) %>% drop_na() %>% 
  mutate(published = as.Date(str_extract(published, "\\d{4}-\\d{2}-\\d{2}"))) %>% 
  left_join(fixed_dates, by="cve") %>% 
  mutate(published = if_else(!is.na(fixed_published), fixed_published, published)) %>% 
  select(cve, published)
  
cvecna <- cves |> 
  select(cve, cna = cveMetadata.assignerShortName) |> 
  drop_na()

```

NOTE: So far, this is the only page that attempts to "fix" the 10,000+ CVEs with an incorrect published date and that's the primary date field used throughout. Some of the charts and graphics may not match with other pages (who incorrectly trust the published date).

The major sections in a CVE record are:

-   metadata - CVE ID, dates, CNA information, etc
-   Description and Title - free text information about the vulnerability
-   Affected - information to identify entity/entities affected by vulnerability
-   Problem Types - CWE information
-   References - URLs to external related sources
-   impacts
-   metrics
-   configurations
-   workarounds
-   solutions
-   exploits
-   timeline
-   credits
-   source
-   tags
-   taxonomy mappings
-   x\_\*

The following section looks at general completeness and statistics about each section.

## Affected (defined with version(s))

Points in the plot are monthly proportions with field, the lines are rolling 90 day windows before the specified time. Showing data with and without "MITRE" listed as the CNA.

```{r}
# affected
affected <- read_parquet(here("cache/cveparse/containers.cna.affected.parquet")) %>% 
  mutate(across(where(is.character), function(x) ifelse(x=="n/a", NA_character_, x)))

empty_rows <- affected %>% 
  filter(across(starts_with("containers.cna.affected"), is.na))
affected_defined <- affected %>% anti_join(empty_rows) %>% 
  distinct(cve, affected_defined = TRUE)

versions <- read_parquet(here("cache/cveparse/containers.cna.affected.versions.parquet")) %>% 
  mutate(across(where(is.character), function(x) ifelse(x=="n/a", NA_character_, x))) %>% 
  filter(!(is.na(containers.cna.affected.versions.version) &
           is.na(containers.cna.affected.versions.lessThanOrEqual) &
           is.na(containers.cna.affected.versions.versionType) &
           is.na(containers.cna.affected.versions.lessThan))) %>% 
  distinct(cve, version_defined = TRUE)



cpe <- read_parquet(here("cache/cveparse/containers.cna.affected.cpes.parquet"))
cpe_parsed <- cpe %>% 
  separate(containers.cna.affected.cpes, 
           into=c("cpe", "cpe_version", "part", "vendor", "product",
                  "version", "update", "edition", "language",
                  "sw_edition", "target_sw", "target_hw", "other"),
           sep="(?<!\\\\):", extra = "merge")
cpe_defined <- cpe %>% distinct(cve) %>% mutate(cpe_defined = TRUE) %>% 
  left_join(cpe_parsed %>% drop_na() %>% distinct(cve) %>% mutate(cpe_valid = TRUE), by="cve") %>% 
  replace_na(list(cpe_valid = FALSE))

all_affected <- affected_defined %>% 
  full_join(versions, by="cve") %>% 
  full_join(cpe_defined, by="cve") %>% 
  full_join(cvepub, by="cve") %>% 
  full_join(cvecna, by="cve") %>% 
  replace_na(list(affected_defined = FALSE,
                  version_defined = FALSE,
                  cpe_defined = FALSE,
                  cpe_valid = FALSE)) %>%
  mutate(affected = affected_defined & version_defined,
         cpe = cpe_defined) %>% 
  select(cve, cna, published, affected, cpe)

toplot <- all_affected %>% 
  pivot_longer(cols=where(is.logical), names_to = "field", values_to = "value") 
alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

monthly_setup <- toplot %>% 
  filter(published >= as.Date("2017-01-01")) %>% 
  mutate(published = floor_date(published, unit = "month"))
monthly <- monthly_setup %>% 
  summarize(.by=c(published, field), x = sum(value), n = n(), pct=x/n, src="All CNAs") %>% 
  bind_rows(monthly_setup %>% 
              filter(cna != "mitre") %>%
              summarize(.by=c(published, field), x = sum(value), n = n(), pct=x/n, src="Without MITRE")) %>% 
  rename(date = published)
allplot <- map_dfr(alldates, function(curdate) {
  one <- toplot %>% 
    filter(published > (curdate - days(90)),
           published <= curdate)
  one %>% 
    summarize(.by=field, x = sum(value), n=n(), pct = x/n, date = curdate, src="All CNAs") %>% 
    bind_rows(one %>% 
                filter(cna != "mitre") %>% 
                summarize(.by=field, x = sum(value), n=n(), pct = x/n, date = curdate, src="Without MITRE"))
})

# gg <- ggplot(allplot %>% filter(field == "affected"), aes(date, pct, group=field, color=field)) +
#   geom_point(data=monthly %>% filter(field == "affected"), alpha=1/2) +
#   geom_line()

final_point <- allplot %>% 
  filter(field == "affected") %>% 
  filter(date == max(date)) %>% 
  mutate(txt = percent(pct, 0.1))


gg1 <- ggplot(allplot %>% filter(field == "affected"), aes(date, pct, group=src, color=src, label=src)) + 
  geom_point(data=monthly %>% filter(field == "affected"), alpha=1/4) +
  geom_text(data=final_point, aes(label=txt), size=9/.pt, family=mainfont,
            hjust="left", nudge_x = 5) +
  geom_line() +
  geomtextpath::geom_textsmooth(method = 'gam',  formula = y ~ s(x, bs = "cs"), 
                                text_smoothing=50, vjust=1, hjust=1, straight=FALSE, text_only=TRUE) +
  scale_y_continuous("Affected w/ Version(s) Defined", label=label_percent(1),
                     limits=c(0,1), breaks=seq(0,1,0.2), expand=c(0.01,0)) +
  scale_color_manual(values=c("All CNAs"=tab("seablue"), "Without MITRE"=tab("blue"))) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg1

cve_tally <- final_point %>% 
  mutate(src = paste0("Affected w/ver: ", src)) %>% 
  select(src, pct)

```

## Affected: CPEs

```{r}
final_point <- allplot %>% 
  filter(field != "affected") %>% 
  filter(date == max(date)) %>% 
  mutate(txt = percent(pct, 0.1))


gg1 <- ggplot(allplot %>% filter(field != "affected"), aes(date, pct, group=src, color=src, label=src)) + 
  geom_point(data=monthly %>% filter(field != "affected"), alpha=1/4) +
  geom_text(data=final_point, aes(label=txt), size=9/.pt, family=mainfont,
            hjust="left", nudge_x = 5) +
  geom_line() +
  geomtextpath::geom_textsmooth(method = 'gam',  formula = y ~ s(x, bs = "cs"), 
                                text_smoothing=50, vjust=1, hjust=1, straight=FALSE, text_only=TRUE) +
  scale_y_continuous("Affected CPEs Defined", label=label_percent(1),
                     limits=c(0,1), breaks=seq(0,1,0.2), expand=c(0.01,0)) +
  scale_color_manual(values=c("All CNAs"=tab("seablue"), "Without MITRE"=tab("blue"))) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg1
cve_tally <- cve_tally %>% 
  bind_rows(final_point %>% 
              mutate(src = paste0("Affected CPE: ", src)) %>% 
              select(src, pct))


```

## Problem Types (CWE Defined)

```{r}
raw_ptype <- read_parquet(here("cache", "cveparse", "containers.cna.problemTypes.parquet")) %>% 
  left_join(read_parquet(here("cache", "cveparse", "containers.cna.problemTypes.descriptions.parquet")), 
            by=c("cve", "problemTypes_id")) %>% 
  mutate(across(where(is.character), function(x) gsub("^n/a$", NA_character_, x)))

cleaned <- raw_ptype %>% 
  rename_with(~ gsub("containers.cna.problemTypes.descriptions.", "", .x, fixed = TRUE))

toplot <- cleaned %>% 
  select(cve, description, lang, type, cweId) %>% 
  mutate(in_desc = str_extract(tolower(description), "cwe[-_.]\\d+"),
         in_cweId = str_extract(tolower(cweId), "cwe[-_.]\\d+")) %>% 
  filter(!(is.na(in_desc) & is.na(in_cweId))) %>% 
  mutate(cwe = case_when(!is.na(in_cweId) ~ toupper(in_cweId),
                         !is.na(in_desc) ~ toupper(in_desc))) %>% 
  filter(!is.na(cwe)) %>% 
  distinct(cve, cwe) %>% 
  mutate(id = gsub("CWE-", "", cwe))

fixdate <- read_parquet(here("../fixed_cve_published_dates_2024-08-27.parquet")) %>% 
  select(cve, realdate=published)
has_cwe <- cvepub %>% 
  left_join(fixdate, by="cve") %>% 
  mutate(published = if_else(!is.na(realdate), realdate, published)) %>% 
  full_join(cvecna, by="cve") %>% 
  mutate(cwe = cve %in% toplot$cve) %>% 
  select(cve, published, cna, cwe)
  


alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

allplot <- map_dfr(alldates, function(curdate) {
  one <- has_cwe %>% 
    filter(published > (curdate - days(90)),
           published <= curdate)
  one %>% 
    summarize(x = sum(cwe), n=n(), pct = x/n, date = curdate, src="All CNAs") %>% 
    bind_rows(one %>% 
                filter(cna != "mitre") %>% 
                summarize(x = sum(cwe), n=n(), pct = x/n, date = curdate, src="Without MITRE"))
})
monthly_setup <- has_cwe %>% 
  filter(published >= as.Date("2017-01-01")) %>% 
  mutate(published = floor_date(published, unit = "month"))
monthly <- monthly_setup %>% 
  summarize(.by=c(published), x = sum(cwe), n = n(), pct=x/n, src="All CNAs") %>% 
  bind_rows(monthly_setup %>% 
              filter(cna != "mitre") %>%
              summarize(.by=c(published), x = sum(cwe), n = n(), pct=x/n, src="Without MITRE")) %>% 
  rename(date = published)

final_point <- allplot %>% filter(date == max(date)) %>% 
  mutate(txt = percent(pct, 0.1))


gg1 <- ggplot(allplot, aes(date, pct, group=src, color=src, label=src)) + 
  geom_point(data=monthly, alpha=1/4) +
  geom_text(data=final_point, aes(label=txt), size=9/.pt, family=mainfont,
            hjust="left", nudge_x = 5) +
  geomtextpath::geom_textpath(text_smoothing=50, vjust=0) +
  scale_y_continuous("CWE ID Defined", label=label_percent(1),
                     limits=c(0,1), breaks=seq(0,1,0.2), expand=c(0.01,0)) +
  scale_color_manual(values=c("All CNAs"=tab("seablue"), "Without MITRE"=tab("blue"))) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg1

cve_tally <- cve_tally %>% 
  bind_rows(final_point %>% 
              mutate(src = paste0("CWE (problem type): ", src)) %>% 
              select(src, pct))


```

## References - Average number of references per CVE

Note that "average" is using a geometric mean to calculate the average over time.

```{r}
ref1 <- read_parquet(here("cache/cveparse/containers.cna.references.parquet")) %>% 
  count(cve) %>% 
  left_join(cvepub, by="cve") %>% 
  left_join(cvecna, by="cve") 
alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

allplot <- map_dfr(alldates, function(curdate) {
  ref1 %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(median = median(n), 
              geomean = exp(mean(log(n))), 
              two_or_more = sum(n >= 2), 
              three_or_more = sum(n >= 3),
              four_or_more = sum(n >= 4),
              total = n(),
              date = curdate)
}) %>% 
  mutate(pct2 = two_or_more / total,
         pct3 = three_or_more / total,
         pct4 = four_or_more / total)

cve_tally <- cve_tally %>% 
  bind_rows(allplot %>% 
              filter(date == max(date)) %>% 
              mutate(src = "References: 3 or more") %>% 
              select(pct=pct3, src))


gg <- ggplot(allplot, aes(date, geomean)) + 
  geom_line() +
  scale_y_continuous("Average Number of References", limits=c(0, NA)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg
```

## References: CVES with 3 or more

```{r}
gg <- ggplot(allplot, aes(date, pct3)) +
  geom_line() +
  geom_area(fill="steelblue", alpha=1/5) +
  scale_y_continuous("Percent of CVEs with 3 or more references",
                     label=label_percent(1), breaks=seq(0,1,0.2),
                     limits=c(0,1), expand=c(0.01, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg
```

## References: Top Tags

```{r}
reftag <- read_parquet(here("cache/cveparse/containers.cna.references.parquet")) %>% 
  distinct(cve, references_id, url = containers.cna.references.url) %>% 
  left_join(read_parquet(here("cache/cveparse/containers.cna.references.tags.parquet")), 
            by=c("cve", "references_id")) %>%
  distinct(cve, url, tag=containers.cna.references.tags) %>% 
  left_join(cvepub, by="cve")

alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

allplot <- map_dfr(alldates, function(curdate) {
  reftag %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    mutate(n = n_distinct(cve, url)) %>% 
    count(tag, n, name="x") %>% 
    mutate(date = curdate)
}) %>% 
  mutate(pct = x/n)

clean_plot <- allplot %>% 
  filter(date >= as.Date("2020-01-01")) %>% 
  summarize(.by=tag, avg = mean(pct)) %>% 
  top_n(n=9, wt=avg) %>% 
  distinct(tag) %>% 
  left_join(allplot, by="tag")

cve_tally <- cve_tally %>% 
  bind_rows(clean_plot %>% filter(is.na(tag), date == max(date)) %>% 
              mutate(src = "References: Tagged",
                     pct = 1 - pct) %>% 
              select(pct, src))

gg <- ggplot(clean_plot, aes(date, pct, group=tag, color=tag)) + 
  facet_wrap(~tag) +
  geom_line() + 
  geom_vline(xintercept = as.Date("2017-01-01"), color="gray60") +
  geom_hline(yintercept = 0, color="gray60") +
  scale_y_continuous("Percent of CVEs with Tag",
                     label=label_percent(1), breaks=seq(0,1,0.2),
                     limits=c(0,1), expand=c(0.01, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none")
        # axis.line = element_line(color="gray50"))
gg
```

## Impacts

Personally, "attack patterns" and "impact" are two very different things, so I find it strange that CAPEC is specified in the "impact" section.

```{r}
imp <- read_parquet(here("cache/cveparse/containers.cna.impacts.parquet")) %>% 
  left_join(read_parquet(here("cache/cveparse/containers.cna.impacts.descriptions.parquet")),
            by=c("cve", "impacts_id")) %>% 
  mutate(with_capec = str_detect(containers.cna.impacts.capecId, "CAPEC-\\d+")) %>% 
  replace_na(list(with_capec = FALSE)) %>% 
  mutate(with_desc = !with_capec & !is.na(containers.cna.impacts.descriptions.value)) %>% 
  summarize(.by=cve, with_capec=any(with_capec), with_desc = any(with_desc)) %>% 
  right_join(cvepub, by = "cve") %>% 
  replace_na(list(with_capec = FALSE, with_desc = FALSE))

alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

allplot <- map_dfr(alldates, function(curdate) {
  imp %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(with_capec = sum(with_capec)/n(),
              with_desc = sum(with_desc)/n(),
              date = curdate)
}) %>% 
  pivot_longer(cols=-date, names_to = "cat", values_to = "val") %>% 
  filter(val > 0) %>% 
  mutate(cat = case_when(cat == "with_capec" ~ "CAPEC",
                         TRUE ~ "Text Description"))
cve_tally <- cve_tally %>%
  bind_rows(allplot %>%
              filter(date == max(date)) %>%
              mutate(src = ifelse(cat == "CAPEC", "Impact: CAPEC", "Impact: Text")) %>%
              select(pct=val, src))

gg <- ggplot(allplot, aes(date, val, group=cat, color=cat, fill=cat, label=cat)) +
  geom_line() +
  geom_area(alpha=1/5) +
  geomtextpath::geom_textsmooth(method = 'gam',  formula = y ~ s(x, bs = "cs"), 
                                text_smoothing=50, vjust=0, hjust=0.94, straight=FALSE, text_only=TRUE) +
  scale_y_continuous("Percent of CVEs",
                     label=label_percent(1), breaks=seq(0,1,0.1),
                     limits=c(0,1), expand=c(0, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg

```

## Metrics

Note that containers.cna.metrics.other is an object with a free text "type" field and an object named "content" which "supports arbitrary JSON". In the CNA container, it looks like most if not all of the "other" metrics is mostly just a free text description of the outcome or impact.

Also, not counting the "scenario" field here. As of 2024-09-07, there were 20,282 CVEs with a scenario, but when we remove the scenario of "GENERAL" we are left with 48 CVEs.

```{r}
other_setup <- list.files(path=here("cache/cveparse"), pattern = "containers.cna.metrics.other")
other_metric <- map_dfr(other_setup, function(curfile) {
  read_parquet(here("cache", "cveparse", curfile)) %>% 
    distinct(cve)
}) %>% distinct(cve) %>% 
  mutate(other_defined = TRUE)

scenarios <- read_parquet(here("cache/cveparse/containers.cna.metrics.scenarios.parquet"))

cna_metric <- read_parquet(here("cache/cveparse/containers.cna.metrics.parquet")) %>% 
  mutate(v2 = !is.na(containers.cna.metrics.cvssV2_0.baseScore) & 
           !is.na(containers.cna.metrics.cvssV2_0.vectorString),
         v3_0 = !is.na(containers.cna.metrics.cvssV3_0.baseScore) & 
           !is.na(containers.cna.metrics.cvssV3_0.vectorString),
         v3_1 = !is.na(containers.cna.metrics.cvssV3_1.baseScore) & 
           !is.na(containers.cna.metrics.cvssV3_1.vectorString),
         v4_0 = !is.na(containers.cna.metrics.cvssV4_0.baseScore) & 
           !is.na(containers.cna.metrics.cvssV4_0.vectorString)) %>% 
  left_join(other_metric, by="cve") %>% 
  right_join(cvepub, by="cve") %>% 
  select(cve, published, starts_with("v"), other=other_defined) %>% 
  replace_na(list(v2 = FALSE, v3_0 = FALSE, v3_1 = FALSE, v4_0 = FALSE, other = FALSE)) %>% 
  mutate(any_CVSS = v2 | v3_0 | v3_1 | v4_0) %>% 
  pivot_longer(cols=c(v2, v3_0, v3_1, v4_0, any_CVSS, other), names_to = "metric", values_to = "val") %>% 
  mutate(metric = case_when(metric == "v2" ~ "CVSS v2.0",
                            metric == "v3_0" ~ "CVSS v3.0",
                            metric == "v3_1" ~ "CVSS v3.1",
                            metric == "v4_0" ~ "CVSS v4.0",
                            metric == "any_CVSS" ~ "Any CVSS",
                            metric == "other" ~ "Other"))

alldates <- seq(as.Date("2017-01-01"), today(), by="2 days")

allplot <- map_dfr(alldates, function(curdate) {
  cna_metric %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(.by=metric, x=sum(val), n=n(), pct=x/n,
              date = curdate)
}) %>% 
  mutate(metric = factor(metric, levels=c("CVSS v2.0", "CVSS v3.0", "CVSS v3.1", "CVSS v4.0", "Any CVSS", "Other"), ordered=TRUE))

cve_tally <- cve_tally %>%
  bind_rows(allplot %>%
              filter(date == max(date), metric != "Other") %>%
              mutate(src = as.character(metric)) %>%
              select(pct, src))

gg <- ggplot(allplot, aes(date, pct, group=metric, color=metric, fill=metric, label=metric)) +
  facet_wrap(~metric) +
  geom_vline(xintercept = as.Date("2017-01-01"), color="gray60") +
  geom_hline(yintercept = 0, color="gray60") +
  geom_line() +
  geom_area(alpha=1/5) +
  scale_y_continuous("Percent of CVEs",
                     label=label_percent(1), breaks=seq(0,1,0.1),
                     limits=c(0,1), expand=c(0, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.03))) +
  theme(legend.position="none")
gg

```

```{r eval=FALSE}
adp_metric <- read_parquet(here("cache/cveparse/containers.adp.metrics.parquet"))
# cna_metric <- read_parquet(here("cache/cveparse/containers.adp.metrics.other.content.options.parquet"))
# cna_metric <- read_parquet(here("cache/cveparse/containers.cna.metrics.scenarios.parquet"))
# cna_metric <- read_parquet(here("cache/cveparse/containers.adp.metrics.scenarios.parquet"))

```

## Configurations

```{r}
do_basic_data <- function(filename, label="placeholder", rmvals=c()) {
  rawdata <- read_parquet(here("cache", "cveparse", filename)) %>% 
    select(cve, value=ends_with(".value")) %>% 
    mutate(value = str_squish(value)) %>% 
    filter(tolower(value) != "n/a",
           nchar(value) > 4)
  if(length(rmvals)) {
    for(curval in rmvals) {
      rawdata <- rawdata %>% 
        filter(!str_detect(value, curval))
    }
  }
  basedata <- rawdata %>% 
    distinct(cve, value=TRUE) %>% 
    right_join(cvepub, by="cve") %>% 
    replace_na(list(value = FALSE))
  allplot <- map_dfr(alldates, function(curdate) {
    basedata %>% 
      filter(published > (curdate - days(90)),
             published <= curdate) %>% 
      summarize(x=sum(value), n=n(), pct=x/n,
                date = curdate)
  }) %>%
    filter(pct > 0)
  
  # print(rawdata %>% count(value, sort=TRUE))
  
  gg <- ggplot(allplot, aes(date, pct)) +
    geom_line(color=tab("red")) +
    geom_area(fill=tab("red"), alpha=1/5) +
    scale_y_continuous("Percent of CVEs",
                       label=label_percent(1), breaks=seq(0,1,0.1),
                       limits=c(0,1), expand=c(0, 0)) +
    scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
                 expand = expansion(mult=c(0,0.06))) +
    theme(legend.position="none",
          axis.line = element_line(color="gray50"))
  list(gg=gg, 
       rawdata=rawdata %>% count(value, sort=TRUE),
       tally = allplot %>% filter(date == max(date)) %>% mutate(src = label) %>% select(src, pct))
       
}

rez <- do_basic_data("containers.cna.configurations.parquet", label="Configurations")

cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)

```

## Workarounds

Removing obvious non-answers such as "There are no \[known\|viable\|available\] workarounds" and others.

```{r}
rmvals <- c("There are no known workarounds", 
            "There are no viable workarounds",
            "There are no available workarounds",
            "No workarounds known",
            "either not available or the currently available")
rez <- do_basic_data("containers.cna.workarounds.parquet", label="Workarounds", rmvals=rmvals)

cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)

```

## Solutions

```{r}
rez <- do_basic_data("containers.cna.solutions.parquet", label="Solutions")
cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)

```

## Exploits

Removing non-answers such as "not aware of" and "None publicly available".

```{r}
rez <- do_basic_data("containers.cna.exploits.parquet", label="Exploits", 
                     rmvals = c("not aware of", "None publicly available"))
cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)

```

## Timeline

```{r}
# foo <- read_parquet(here("cache/cveparse/containers.cna.timeline.parquet"))
# foo %>% mutate(x = gsub("\\d", "d", containers.cna.timeline.time)) %>% 
#   count(x, sort=TRUE)
rez <- do_basic_data("containers.cna.timeline.parquet", label="Timeline") 
cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)


```

## Credits

```{r}
rez <- do_basic_data("containers.cna.credits.parquet", label="Credits")
cve_tally <- cve_tally %>%
  bind_rows(rez$tally)

print(rez$gg)

```

## Source

From the schema:

"This is the source information (who discovered it, who researched it, etc.) and optionally a chain of CNA information (e.g. the originating CNA and subsequent parent CNAs who have processed it before it arrives at the MITRE root). Must contain: IF this is in the root level it MUST contain a CNA_chain entry, IF this source entry is NOT in the root (e.g. it is part of a vendor statement) then it must contain at least one type of data entry.",

But in reality, Cisco is the only CNA using this, and the only value appears to be in the "source.defects" and they all appear to look like "CSCvz91984", "CSCvz93493", "CSCvz93504"

```{r}
# rez <- do_basic_data("containers.cna.source.defects.parquet")
# foo <- read_parquet(here("cache/cveparse/containers.cna.source.defects.parquet"))

rawdata <- read_parquet(here("cache/cveparse/containers.cna.source.defects.parquet")) %>% 
  select(cve, value=containers.cna.source.defects) %>% 
  mutate(value = str_squish(value)) %>% 
  filter(tolower(value) != "n/a",
         nchar(value) > 4)
basedata <- rawdata %>% 
  distinct(cve, value=TRUE) %>% 
  right_join(cvepub, by="cve") %>% 
  replace_na(list(value = FALSE))
allplot <- map_dfr(alldates, function(curdate) {
  basedata %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(x=sum(value), n=n(), pct=x/n,
              date = curdate)
}) %>%
  filter(pct > 0)

cve_tally <- cve_tally %>% 
  bind_rows(allplot %>% filter(date == max(date)) %>% 
              mutate(src = "Source/Defects") %>% select(src, pct))

# print(rawdata %>% count(value, sort=TRUE))

gg <- ggplot(allplot, aes(date, pct)) +
  geom_line(color=tab("red")) +
  geom_area(fill=tab("red"), alpha=1/5) +
  scale_y_continuous("Percent of CVEs",
                     label=label_percent(1), breaks=seq(0,1,0.1),
                     limits=c(0,1), expand=c(0, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg

```

## Tags

```{r}

rawdata <- read_parquet(here("cache/cveparse/containers.cna.tags.parquet")) %>% 
  select(cve, value=containers.cna.tags) %>% 
  mutate(value = str_squish(value)) %>% 
  filter(tolower(value) != "n/a",
         nchar(value) > 4)
basedata <- rawdata %>% 
  distinct(cve, value=TRUE) %>% 
  right_join(cvepub, by="cve") %>% 
  replace_na(list(value = FALSE))
allplot <- map_dfr(alldates, function(curdate) {
  basedata %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(x=sum(value), n=n(), pct=x/n,
              date = curdate)
}) %>%
  filter(pct > 0)

cve_tally <- cve_tally %>% 
  bind_rows(allplot %>% filter(date == max(date)) %>% 
              mutate(src = "Tags") %>% select(src, pct))

# print(rawdata %>% count(value, sort=TRUE))

gg <- ggplot(allplot, aes(date, pct)) +
  geom_line(color=tab("red")) +
  geom_area(fill=tab("red"), alpha=1/5) +
  scale_y_continuous("Percent of CVEs",
                     label=label_percent(1), breaks=seq(0,1,0.1),
                     limits=c(0,1), expand=c(0, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg

```

## Taxonomy Mappings

As of 2024-09-07, there are a 2 CVEs from 2023 with ATT&CK mappings...

```{r}
# foo <- read_parquet(here("cache/cveparse/containers.cna.taxonomyMappings.taxonomyRelations.parquet"))
basedata <- read_parquet(here("cache/cveparse/containers.cna.taxonomyMappings.parquet")) %>% 
  distinct(cve, value=TRUE) %>% 
  right_join(cvepub, by="cve") %>% 
  replace_na(list(value = FALSE))
allplot <- map_dfr(alldates, function(curdate) {
  basedata %>% 
    filter(published > (curdate - days(90)),
           published <= curdate) %>% 
    summarize(x=sum(value), n=n(), pct=x/n,
              date = curdate)
}) %>%
  filter(pct > 0)

# print(rawdata %>% count(value, sort=TRUE))
cve_tally <- cve_tally %>% 
  bind_rows(allplot %>% filter(date == max(date)) %>% 
              mutate(src = "Taxonomy") %>% select(src, pct))

gg <- ggplot(allplot, aes(date, pct)) +
  geom_line(color=tab("red")) +
  geom_area(fill=tab("red"), alpha=1/5) +
  scale_y_continuous("Percent of CVEs",
                     label=label_percent(1), breaks=seq(0,1,0.1),
                     limits=c(0,1), expand=c(0, 0)) +
  scale_x_date("CVE published", date_breaks = "1 year", date_labels = "%Y", 
               expand = expansion(mult=c(0,0.06))) +
  theme(legend.position="none",
        axis.line = element_line(color="gray50"))
gg
```

# Everything

This summarizes the last point in all of the line plots above, looking at each value over the last 90 days.

```{r fig.height=6}
toplot <- cve_tally %>% 
  mutate(src = factor(src, levels=rev(src), ordered=TRUE),
         txt = ifelse(pct < 0.001, "<0.1", percent(pct, 0.1)))

gg <- ggplot(toplot, aes(pct, src, label=txt)) +
  geom_col() +
  ggfittext::geom_bar_text(size=8, family=mainfont) +
  scale_x_continuous("Percent of CVES in last 90 days (except refs tagged)", limits=c(0,1),
                     label=label_percent(1), breaks=seq(0,1,0.2), expand=c(0,0)) +
  theme(axis.title.y = element_blank(),
        axis.line.y = element_line(color="gray50"))
gg
```

### Date Consistency

This normalizes the various date formats present in the data and compares across the date fields.

The percent shown is the percent of date values within each date field and not CVE records or across all date values.

```{r fig.height=7}
# cvemetadata
# cna container
# adp container

datemap <- c("dddd-dd-ddTdd:dd:dd" = "YYYY-MM-DDThh:mm:ss",
             "dddd-dd-ddTdd:dd:ddZ" = "YYYY-MM-DDThh:mm:ssZ", 
             "dddd-dd-ddTdd:dd:dd+dd:dd" = "YYYY-MM-DDThh:mm:ss[+-]hh:mm", 
             "dddd-dd-ddTdd:dd:dd.dddZ" = "YYYY-MM-DDThh:mm:ss.sssZ", 
             "dddd-dd-ddTdd:dd:dd.ddd-dd:dd" = "YYYY-MM-DDThh:mm:ss.sss[+-]hh:mm", 
             "dddd-dd-ddTdd:dd:dd.dddddd" = "YYYY-MM-DDThh:mm:ss.sssss", 
             "dddd-dd-ddTdd:dd:dd.ddddddZ" = "YYYY-MM-DDThh:mm:ss.ssssssZ", 
             "dddd-dd-ddTdd:dd:dd.dddddd+dd:dd" = "YYYY-MM-DDThh:mm:ss.sssss[+-]hh:mm") %>% 
  enframe(name="pattern", value="normalized")
coredate <- read_parquet(here("cache", "cveparse", "cves.parquet")) %>% 
  select(cve, contains("date")) %>% 
  gather(cat, val, -cve) %>% 
  drop_na() %>% 
  mutate(pattern = gsub("\\d", "d", val)) %>% 
  left_join(datemap, by="pattern") %>% 
  count(normalized, cat) %>% 
  mutate(normalized = factor(normalized, levels=rev(datemap$normalized), ordered=TRUE)) %>% 
  mutate(.by=cat, pct = n/sum(n), 
         txt = ifelse(pct < 0.0006, "<0.1%", percent(pct, 0.1))) %>% 
  complete(cat, normalized) 

gg <- ggplot(coredate, aes(cat, normalized, fill=pct, label=txt)) +
  geom_tile(height=0.9, width=0.9, color="gray70") +
  geom_text(data=coredate %>% drop_na(), size=9/.pt, family=mainfont) +
  scale_fill_gradientn(colors=wesanderson::wes_palette('Zissou1', n=255, type='continuous'),
                       trans=pseudo_log_trans(0.05), na.value='white', limits=c(0,1)) +
  scale_x_discrete(position="top", expand=expansion(add = c(0,1))) +
  theme(axis.text.x = element_text(angle=60, hjust=0, vjust=1),
        legend.position="none",
        panel.grid = element_blank(),
        axis.title = element_blank())
gg
```
